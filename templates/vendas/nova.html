{% extends 'base.html' %}

{% block title %}Nova Venda{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="container-venda">
    <header class="mb-4">
        <h1 class="h2 text-primary">Nova Venda</h1>
        

    </header>

    <div class="grid-venda">
        <!-- Lista de Produtos -->
        <section class="card">
            <input type="text" id="filtro-produto" class="form-control mb-3" placeholder="Buscar produto...">

            <table class="table">
                <thead>
                    <tr>
                        <th>Imagem</th> <!-- Nova coluna -->
                        <th>Produto</th>
                        <th>Preço</th>
                        <th>Estoque</th>
                        <th class="text-center">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in produtos %}
                    <tr class="produto-item align-middle" data-id="{{ p.id }}" data-estoque="{{ p.quantidade }}" data-tipo="{{ p.tipo_venda }}">
                        <td> <!-- Nova célula para imagem -->
                            {% if p.foto %}
                                <img src="{{ url_for('static', filename=p.foto) }}" 
                                     alt="{{ p.nome }}"
                                     class="img-thumbnail"
                                     style="max-width: 50px; height: auto;">
                            {% else %}
                                <div class="no-image">-</div>
                            {% endif %}
                        </td>
                        <td>{{ p.nome }}</td>
                        <td>
                            {% if p.tipo_venda == 'quilo' %}
                                <input type="number" step="0.01" class="form-control form-control-sm preco-quilo" placeholder="R$/kg">
                            {% else %}
                                R$ {{ "%.2f"|format(p.preco) }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-estoque">
                                {{ p.quantidade }} {% if p.tipo_venda == 'quilo' %}kg{% else %}unid.{% endif %}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if p.tipo_venda == 'quilo' %}
                                <input type="number" step="0.01" class="form-control form-control-sm peso-quilo" placeholder="Kg">
                            {% else %}
                                <input type="number" min="1" max="{{ p.quantidade }}" class="form-control form-control-sm quantidade-input" value="1">
                            {% endif %}
                            <button class="btn btn-sm btn-primary btn-adicionar ml-2">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center">Nenhum produto encontrado</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- Carrinho -->
        <aside class="carrinho card">
            <h4 class="mb-3">Carrinho</h4>
            <form id="form-venda">
                <div class="form-group">
                    <label for="nome_cliente">Nome do Cliente</label>
                    <input type="text" id="nome_cliente" name="nome_cliente" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="cpf">CPF do Cliente</label>
                    <input type="text" id="cpf" name="cpf" class="form-control" placeholder="000.000.000-00" required>
                </div>
                <div class="form-group">
                    <select id="metodo_pagamento" name="metodo_pagamento" class="form-control">
                        <option>Dinheiro</option>
                        <option>Cartão Débito</option>
                        <option>Cartão Crédito</option>
                        <option>PIX</option>
                        <option value="pagamento_prazo">Pagamento a Prazo</option>
                    </select>
                    
                    <div class="form-group mt-2" id="fiado-due-date" style="display: none;">
                        <label for="data_vencimento">Data de Vencimento</label>
                        <input type="date" 
                            id="data_vencimento" 
                            name="data_vencimento" 
                            class="form-control"
                            min="{{ current_date }}">
                    </div>
                </div>

                <div id="itens-carrinho" class="mb-3">
                    <!-- Itens adicionados via JS -->
                </div>

                <div class="mb-3">
                    <h5 class="text-primary">Total: <span id="total-venda">R$ 0,00</span></h5>
                </div>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-primary btn-block">Finalizar Venda</button>
            </form>
        </aside>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
document.addEventListener('DOMContentLoaded', () => {
    const carrinho = {};
    const form = document.getElementById('form-venda');

    // Filtro de produtos
    document.getElementById('filtro-produto').addEventListener('input', e => {
        const filtro = e.target.value.toLowerCase();
        document.querySelectorAll('.produto-item').forEach(row => {
            row.style.display = row.children[0].textContent.toLowerCase().includes(filtro) ? '' : 'none';
        });
    });

    // Função para atualizar carrinho
    function atualizarCarrinho() {
        const container = document.getElementById('itens-carrinho');
        let html = '';
        let total = 0;
        Object.entries(carrinho).forEach(([id, item]) => {
            total += item.preco * item.quantidade;
            html += `<div class="item-carrinho mb-2" data-id="${id}">
                        ${item.nome} (${item.quantidade} x R$ ${item.preco.toFixed(2)})
                        <button type="button" class="btn btn-sm btn-danger btn-remover" title="Remover">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
        });
        container.innerHTML = html;
        document.getElementById('total-venda').textContent = `R$ ${total.toFixed(2)}`.replace('.', ',');
        // Eventos de remoção
        document.querySelectorAll('.btn-remover').forEach(btn => {
            btn.addEventListener('click', e => {
                const id = e.target.closest('.item-carrinho').dataset.id;
                delete carrinho[id];
                atualizarCarrinho();
            });
        });
    }

    // Adicionar produtos
    // Adicionar produtos
    document.querySelectorAll('.btn-adicionar').forEach(btn => {
        btn.addEventListener('click', () => {
            const row = btn.closest('.produto-item');
            const tipo = row.dataset.tipo;
            let quantidade, preco;
            if (tipo === 'quilo') {
                const precoInput = row.querySelector('.preco-quilo');
                const pesoInput = row.querySelector('.peso-quilo');
                // Replace commas with dots for proper parsing
                preco = parseFloat(precoInput.value.replace(',', '.'));
                quantidade = parseFloat(pesoInput.value.replace(',', '.'));
                if (!preco || preco <= 0) return alert('Informe o preço por quilo!');
                if (!quantidade || quantidade <= 0) return alert('Informe o peso!');
            } else {
                preco = parseFloat(row.children[1].textContent.replace('R$ ', ''));
                quantidade = parseInt(row.querySelector('.quantidade-input').value);
            }
            const id = row.dataset.id;
            const estoque = parseFloat(row.dataset.estoque);
            if (quantidade > estoque) return alert('Quantidade indisponível!');
            if (carrinho[id]) {
                carrinho[id].quantidade += quantidade;
            } else {
                carrinho[id] = { nome: row.children[0].textContent, preco, quantidade };
            }
            atualizarCarrinho();
        });
    });

    // Mostrar/ocultar data de vencimento
    document.getElementById('metodo_pagamento').addEventListener('change', function(e) {
        const fiadoDiv = document.getElementById('fiado-due-date');
        fiadoDiv.style.display = e.target.value === 'pagamento_prazo' ? 'block' : 'none';
    });
    form.addEventListener('submit', async e => {
        e.preventDefault(); // Manter apenas uma chamada
        
        const metodoPagamento = document.getElementById('metodo_pagamento').value;
        const dataVencimento = document.getElementById('data_vencimento').value;
    
        // Validação para pagamento a prazo
        if (metodoPagamento === 'pagamento_prazo') {
            if (!dataVencimento) {
                return alert('Informe a data de vencimento para vendas fiado!');
            }
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            vencimento.setHours(23, 59, 59);
            
            if (vencimento < hoje) {
                return alert('Data de vencimento não pode ser anterior à data atual!');
            }
        }
    
        const itens = Object.entries(carrinho).map(([id, item]) => ({ 
            id: +id, 
            preco: item.preco, 
            quantidade: item.quantidade 
        }));
        
        if (!itens.length) return alert('Adicione itens ao carrinho!');
    
        try {
            const response = await fetch("{{ url_for('nova_venda') }}", {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    nome_cliente: form.nome_cliente.value,
                    cpf: form.cpf.value,
                    metodo_pagamento: metodoPagamento,
                    data_vencimento: dataVencimento,
                    itens: itens
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert(`Venda registrada! ID: ${result.venda_id}`);
                window.location.reload();
            } else {
                alert(`Erro: ${result.error}`);
            }
        } catch (error) {
            alert('Erro ao processar venda!');
            console.error(error);
        }
    });

    });

</script>
{% endblock %}
